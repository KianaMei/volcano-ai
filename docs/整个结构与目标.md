# Volcano Chat 生产级系统设计规约 (2025 Revised)

基于最新的代码实现分析，本规约反映了系统当前的实际架构：**Java 后端全权代理模式**。

## 1. 核心架构：全栈 Java 代理

系统已摒弃独立的 Node.js Token 服务，将所有安全、鉴权与代理逻辑收敛至 Java Spring Boot 后端。同时，保留了**身份交换 (Identity Swap)** 模式，确保业务方（网站A）对用户身份的掌控。

### 整体架构图

```mermaid
graph TD
    User((用户)) -->|交互| Widget[Chat Widget<br/>Vue/Nuxt 3 前端]
    Widget -->|SSE 流式聊天| Backend[Chat Service<br/>Java Spring Boot]
    Widget -->|WebSocket TTS/ASR| Backend
    Backend -->|代理请求| Coze[Coze OpenAPI]
    Backend -->|存储日志| MySQL[(MySQL)]
    Backend -->|Token 缓存| Redis[(Redis)]
    
    subgraph "产业互联网"
        WebA[产业互联网后端]
    end
    
    WebA -->|S2S 创建会话| Backend
    Widget -.->|初始化获取 Token| WebA
```

### 交互时序图

```mermaid
sequenceDiagram
    participant Widget as Chat Widget (前端)
    participant WebA as 网站A后端 (业务方)
    participant Chat as Chat Service (Spring Boot)
    participant Redis as Redis Cache
    participant DB as MySQL
    participant Coze as Coze OpenAPI

    Note over Widget, Chat: 阶段一：身份交换 (S2S)
    Widget->>WebA: 1. 页面加载/初始化
    WebA->>Chat: 2. S2S 请求会话 /api/internal/session/create (Phone: 138xx)
    Chat->>Redis: 3. 生成内部 Token & 绑定手机号
    Chat-->>WebA: 4. 返回内部 Token
    WebA-->>Widget: 5. 下发内部 Token 给挂件

    Note over Widget, Coze: 阶段二：代理交互与流式记录
    Widget->>Chat: 6. 发送消息 (携带内部 Token)
    Chat->>Redis: 7. 校验 Token & 换取 UserID (138xx)
    
    par 并行处理
        Chat->>DB: 8. 将提问内容写入mysql数据库
        opt Coze Token Check
            Chat->>Coze: 9. (若需) 请求 OAuth Token
            Coze-->>Chat: 10. 返回 Access Token
        end
        Chat->>Coze: 11. 透传请求 (Token + UserID)
    end

    Coze-->>Chat: 12. SSE 流式响应
    Chat-->>Widget: 13. 转发 SSE 流

    Note over Chat, DB: 阶段三：回答归档
    Coze-->>Chat: 14. 响应结束
    Chat->>DB: 15. 将回答内容写入mysql数据库
    Chat-->>Widget: 16. 关闭连接
```

## 2. 关键技术变更

### 2.1 鉴权服务内聚 (Refactored)
*   **旧方案**: 依赖 `coze-token-service` (Node.js) 生成 JWT。
*   **新方案**: `Chat Service` 内部集成 `CozeAccessTokenProvider`。
    *   直接使用 `coze-api` Java SDK。
    *   实现了 OAuth Token 的自动获取与本地缓存。
    *   增加了 PAT (Personal Access Token) 作为降级容灾方案。

### 2.2 存储方案 (MySQL & Redis)

#### 数据流分析 (目标架构)
生产环境应采用**后端异步分步记录**策略，以确保数据生成的实时性与准确性，避免前端上报可能带来的篡改风险或丢失。

1.  **会话状态 (Redis)**:
    *   维护 `Internal Token` <-> `User Phone` 映射，确保请求的合法性。
    *   缓存 Coze OAuth Token。

2.  **日志记录 (MySQL)**:
    *   **核心逻辑**: 问与答在时间轴上是分离的，存储也应遵循此逻辑。
    *   **流程**: 
        *   **T1 (提问时刻)**: 后端收到请求，立即将提问内容写入mysql数据库，状态标记为“进行中”。
        *   **T2 (回答时刻)**: 后端流式接收 Coze 响应。
        *   **T3 (结束时刻)**: 响应结束，将回答内容写入mysql数据库，状态标记为“已完成”。

---

## 3. 待办事项

### 已完成
- [x] Token 服务内化：Java 后端原生支持 Coze OAuth JWT
- [x] 代理接口：`/api/chat/send` 接管 Coze 通信
- [x] Widget 连接 Java 后端 (Port 8081)

### 待处理
- [ ] S2S 鉴权增强：为 `/internal/session/create` 加 IP 白名单或签名校验
- [ ] SSE 重连机制：网络波动下的稳定性
- [ ] 限流策略：按 UserID 或 IP 限速
- [ ] 日志审计：完善 MySQL 日志结构